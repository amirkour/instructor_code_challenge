<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Movies!</title>
    </head>
    <body>
        <div id="feedback" style="display:none;"></div>
        <div id="container"></div>

        <!-- all the view templates will be in this hidden div -->
        <div style="display:none;">
            <div id="home-view">
                <input type="text" id="search-textbox" placeholder="Search OMDB API" />
                <input type="button" id="search-button" value="Search" />
                <ul id="search-result-list">
                </ul>
            </div>
        </div>
    </body>

    <script type="text/javascript" src="/ajax-helpers.js" />
    <script>

    

    // parent app - hosts utility and helpers for the rest of the app
    var spaApplication = (function(window,document,undefined){

        if(window.spaApplication) return window.spaApplication;

        var ApplicationKlass = function(){
            this.feedbackDiv = document.getElementById("feedback");
        }
        ApplicationKlass.prototype.displayFeedback = function(strText, status){
            if(typeof strText !== 'string' || strText.length <= 0) return;
            this.feedbackDiv.innerHTML = strText;
            switch(status){
                case 'error':
                    this.feedbackDiv.style.border = "1px solid red";
                    break;
                case 'info':
                    this.feedbackDiv.style.border = "1px solid green";
                    break;
                default:
                    this.feedbackDiv.style.border = "1px solid blue";
                    break;
            }

            this.feedbackDiv.style.display = "block";
        }
        ApplicationKlass.prototype.displayError = function(strText){
            this.displayFeedback(strText,'error');
        }
        ApplicationKlass.prototype.displayInfo = function(strText){
            this.displayFeedback(strText,'info');
        }
        ApplicationKlass.prototype.clearFeedback = function(){
            this.feedbackDiv.innerHTML = '';
            this.feedbackDiv.style.display = "none";
        }

        return new ApplicationKlass();

    })(window,document);

    // TODO - JSON not supported in older browsers ...
    (function(window,document,JSON,ajax,app,undefined){

        // TODO - event binding on search-result-list
        // TODO - should be rendering views w/ the app, so event handling can happen

        cbEmpty = function(){}

        var ViewKlass = function(options){
            var self = this;

            // the html that will render for your view - should be a plain-old string of html
            this.html = options.html || '';

            // the dom element on the page that your view will render into
            this.viewAnchor = options.viewAnchor;

            // the ui hash you pass in is expected to be of the form
            // { 'foo': '#selector' }
            //
            // where 'foo' is the name of that element for your view (ie: this.foo),
            // and the selector must be of the form
            // '#some-selector'
            //
            // where 'some-selector' is the id of the element that 'this.foo' should point to.
            // for now, this.ui only supports ID selectors, for simplicity of the demo.
            this.ui = options.ui;

            // pass in any functions to add to your view via the 'functions' option
            // which should be of the form
            // functions: { nameOfFunction: function(){ ... }, ... }
            for(var nextFunction in options.functions) this[nextFunction] = options.functions[nextFunction];

            // pass events you want to have bound after your view is rendered.
            // this is expected to be a list of the form:
            // [
            //    {event: 'name of event', element: 'foo', handler: 'nameOfFunction'},
            //    { ... }, ...
            // ]
            // where 'event' is the name of the event to bind (like 'click' or 'keyup'),
            //       'element' is the name of an element you specify in options.ui, and
            //       'handler' is a function you specify with options.functions
            this.events = options.events || [];

            if(!(this.viewAnchor instanceof HTMLElement)) throw "viewAnchor must be an html element";
        }

        // call this to render your view. for example:
        // var myCoolView = new ViewKlass({ ... });
        // myCoolView.render();
        ViewKlass.prototype.render = function(){
            this.viewAnchor.innerHTML = this.html;
            this._bindUIElements();
            this._bindEvents();
            if(typeof this.onRenderComplete === 'function') this.onRenderComplete();
        }

        // will be called automatically after your view has been rendered,
        // and will bind all of your 'ui' hash elements to the view.
        // this call MUST come after a call to render, as your view's html
        // will not exist in the DOM until then.
        ViewKlass.prototype._bindUIElements = function(){
            if(!this.ui) return;
            for(var strName in this.ui){
                var strSelector = this.ui[strName];
                if(typeof strSelector !== 'string' || strSelector.length <= 0 || strSelector[0] !== '#') throw "UI selectors must be a string of the form #foo";

                // TOOD - querySelectorAll comes w/ a price ...
                this[strName] = this.viewAnchor.querySelectorAll(strSelector)[0];
            }
        }

        // will get called automatically after you render your view, and will bind
        // any events you passed in during construction
        ViewKlass.prototype._bindEvents = function(){
            if(!this.events || this.events.length <= 0) return;

            for(var i = 0, iLen = this.events.length; i < iLen; i++){
                var nextEventData = this.events[i];
                this._bind(nextEventData.element, nextEventData.event, nextEventData.handler);
            }
        }

        // capture closure for binding the given element to the given event with the given
        // handler function.
        // this function assumes that the given element and handler are bound to 'this'
        // already
        ViewKlass.prototype._bind = function(strElementName, strEventName, strHandlerName){
            var self = this;
            this[strElementName].addEventListener(strEventName, function(){
                self[strHandlerName].apply(self,arguments);
            });
        }



        var homePage = new ViewKlass({
            html: document.getElementById("home-view").innerHTML,
            viewAnchor: document.getElementById("container"),
            ui:{
                'searchBox': '#search-textbox',
                'searchButton': '#search-button',
                'searchResultList': "#search-result-list"
            },
            events:[
                {event: 'keyup', element: 'searchBox', handler: 'onSearchBoxKeyup'},
                {event: 'click', element: 'searchButton', handler: 'onSearchClick'}
            ],
            functions:{
                onRenderComplete:function(){
                    this.searchBox.focus();
                },
                performMovieSearch:function(strSearch){
                    app.clearFeedback();
                    if(typeof strSearch !== 'string'){
                        app.displayError("Search term must be a valid string");
                        return;
                    }

                    if(strSearch.length <= 0) return;

                    // TODO - busy icon
                    // TODO - button disabled, textbox disabled
                    var self = this;
                    ajax.request({
                        url: 'http://www.omdbapi.com/?s=' + strSearch,
                        type:'get',
                        success: function(strJsonResponse){

                            var omdbResponse = null;
                            try{
                                omdbResponse = JSON.parse(strJsonResponse);
                            }catch(e){
                                app.displayError("Encountered this error after movie request succeeded, please try again: " + e);
                                return;
                            }

                            if(omdbResponse == null){
                                app.displayError("Unexpected response format, please try again");
                                return;
                            }

                            if(omdbResponse.Response === 'False'){
                                var strError = typeof omdbResponse.Error === 'string' && omdbResponse.Error.length > 0 ? omdbResponse.Error : "Unknown error from OMDBAPI";
                                app.displayError(strError);
                                return;
                            }

                            if(!omdbResponse.Search){
                                app.displayError("Failed to retrieve any search results from OMDBAPI");
                                return;
                            }

                            self.displayMoveSearchResults(omdbResponse.Search);
                            // TODO - busy icon off
                            // TODO - button enabled, textbox enabled
                        },
                        error:function(status, xmlhttp){
                            var strError = typeof xmlhttp.responseText === 'string' ? xmlhttp.responseText : "Unknown error";
                            app.displayError("Encountered the following error, please try again: " + strError);
                            // TODO - busy icon off
                            // TODO - button enabled, textbox enabled
                        }
                    });
                },
                displayMoveSearchResults: function(results){
                    if(results == null){
                        app.displayError("Missing required result list, cannot show movie search results");
                        return;
                    }

                    // [{"Title":"Star Wars: Episode IV - A New Hope","Year":"1977","imdbID":"tt0076759","Type":"movie"}...]
                    var newResultListFragment = document.createDocumentFragment(),
                        newLi = null,
                        newButton = null,
                        newFave = null;
                    for(var i = 0, iLen = results.length; i < iLen; i++){
                        newLi = document.createElement("LI");

                        newButton = document.createElement("BUTTON");
                        newButton.type = 'button';
                        newButton.appendChild( document.createTextNode(results[i].Title) );
                        newLi.appendChild(newButton);

                        newFave = document.createElement("BUTTON");
                        newFave.type = 'button';
                        newFave.appendChild( document.createTextNode('Favorite!') );//TODO - make this an icon
                                                                                    //TODO - needs to contain ID for event handler
                        newLi.appendChild(newFave);

                        newResultListFragment.appendChild(newLi);
                    }

                    this.searchResultList.innerHTML = "";
                    this.searchResultList.appendChild(newResultListFragment);
                },
                onSearchBoxKeyup: function(e){
                    if(e.keyCode === 13){
                        this.performMovieSearch(this.searchBox.value);  
                    } 
                },
                onSearchClick:function(e){
                    this.performMovieSearch(this.searchBox.value);
                }
            }
        });

        homePage.render();
        
    })(window,document,JSON,ajaxHelpers,spaApplication);
    
    </script>
</html>