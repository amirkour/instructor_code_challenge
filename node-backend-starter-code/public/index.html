<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Movies!</title>
    </head>
    <body>
        <div id="feedback" style="display:none;"></div>
        <div id="container"></div>

        <!-- all the view templates will be in this hidden div -->
        <div style="display:none;">
            <div id="home-view">
                <input type="text" id="search-textbox" placeholder="Search OMDB API" />
                <input type="button" id="search-button" value="Search" />
                <ul id="search-result-list">
                </ul>
            </div>
        </div>
    </body>

    <script type="text/javascript" src="/ajax-helpers.js" ></script>
    <script type="text/javascript" src="/spa-application.js"></script>
    <script type="text/javascript" src="/spa-view.js"></script>
    <script>

    // TODO - JSON not supported in older browsers ...
    (function(window,document,JSON,ajax,app,SPAViewKlass,undefined){

        // TODO - event binding on search-result-list
        // TODO - should be rendering views w/ the app, so event handling can happen

        var homePage = new SPAViewKlass({
            html: document.getElementById("home-view").innerHTML,
            viewAnchor: document.getElementById("container"),
            ui:{
                'searchBox': '#search-textbox',
                'searchButton': '#search-button',
                'searchResultList': "#search-result-list"
            },
            events:[
                {event: 'keyup', element: 'searchBox', handler: 'onSearchBoxKeyup'},
                {event: 'click', element: 'searchButton', handler: 'onSearchClick'}
            ],
            functions:{
                onRenderComplete:function(){
                    this.searchBox.focus();
                },
                performMovieSearch:function(strSearch){
                    app.clearFeedback();
                    if(typeof strSearch !== 'string'){
                        app.displayError("Search term must be a valid string");
                        return;
                    }

                    if(strSearch.length <= 0) return;

                    // TODO - busy icon
                    // TODO - button disabled, textbox disabled
                    var self = this;
                    ajax.request({
                        url: 'http://www.omdbapi.com/?s=' + strSearch,
                        type:'get',
                        success: function(strJsonResponse){

                            var omdbResponse = null;
                            try{
                                omdbResponse = JSON.parse(strJsonResponse);
                            }catch(e){
                                app.displayError("Encountered this error after movie request succeeded, please try again: " + e);
                                return;
                            }

                            if(omdbResponse == null){
                                app.displayError("Unexpected response format, please try again");
                                return;
                            }

                            if(omdbResponse.Response === 'False'){
                                var strError = typeof omdbResponse.Error === 'string' && omdbResponse.Error.length > 0 ? omdbResponse.Error : "Unknown error from OMDBAPI";
                                app.displayError(strError);
                                return;
                            }

                            if(!omdbResponse.Search){
                                app.displayError("Failed to retrieve any search results from OMDBAPI");
                                return;
                            }

                            self.displayMoveSearchResults(omdbResponse.Search);
                            // TODO - busy icon off
                            // TODO - button enabled, textbox enabled
                        },
                        error:function(status, xmlhttp){
                            var strError = typeof xmlhttp.responseText === 'string' ? xmlhttp.responseText : "Unknown error";
                            app.displayError("Encountered the following error, please try again: " + strError);
                            // TODO - busy icon off
                            // TODO - button enabled, textbox enabled
                        }
                    });
                },
                displayMoveSearchResults: function(results){
                    if(results == null){
                        app.displayError("Missing required result list, cannot show movie search results");
                        return;
                    }

                    // [{"Title":"Star Wars: Episode IV - A New Hope","Year":"1977","imdbID":"tt0076759","Type":"movie"}...]
                    var newResultListFragment = document.createDocumentFragment(),
                        newLi = null,
                        newButton = null,
                        newFave = null;
                    for(var i = 0, iLen = results.length; i < iLen; i++){
                        newLi = document.createElement("LI");

                        newButton = document.createElement("BUTTON");
                        newButton.type = 'button';
                        newButton.appendChild( document.createTextNode(results[i].Title) );
                        newLi.appendChild(newButton);

                        newFave = document.createElement("BUTTON");
                        newFave.type = 'button';
                        newFave.appendChild( document.createTextNode('Favorite!') );//TODO - make this an icon
                                                                                    //TODO - needs to contain ID for event handler
                        newLi.appendChild(newFave);

                        newResultListFragment.appendChild(newLi);
                    }

                    this.searchResultList.innerHTML = "";
                    this.searchResultList.appendChild(newResultListFragment);
                },
                onSearchBoxKeyup: function(e){
                    if(e.keyCode === 13){
                        this.performMovieSearch(this.searchBox.value);  
                    } 
                },
                onSearchClick:function(e){
                    this.performMovieSearch(this.searchBox.value);
                }
            }
        });

        homePage.render();
        
    })(window,document,JSON,ajaxHelpers,spaApplication,SPAViewKlass);
    
    </script>
</html>