<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Movies!</title>
    </head>
    <body>
        <div id="feedback" style="display:none;"></div>
        <div id="container"></div>

        <!-- all the view templates will be in this hidden div -->
        <div style="display:none;">
            <div id="home-view">
                <input type="text" id="search-textbox" placeholder="Search OMDB API" />
                <input type="button" id="search-button" value="Search" />
                <ul id="search-result-list">
                </ul>
            </div>
            <div id="movie-view">

            </div>
        </div>
    </body>

    <script type="text/javascript" src="/ajax-helpers.js" ></script>
    <script type="text/javascript" src="/spa-application.js"></script>
    <script type="text/javascript" src="/spa-view.js"></script>
    <script>

    // TODO - JSON not supported in older browsers ...
    (function(window,document,JSON,ajax,app,SPAViewKlass,undefined){

        // TODO - event binding on search-result-list
        // TODO - should be rendering views w/ the app, so event handling can happen

        // there are two conceptual types of buttons on the home page:
        // 1. a button for a movie search result, and
        // 2. a button to add a search result to the 'favorites'
        //
        // these constants will help differentiate b/w those two types of buttons:
        var BUTTON_TYPE_MOVIE = 'movieButton',
            BUTTON_TYPE_FAVORITE = 'movieFavoriteButton';

        // when the user clicks a 'favorite' button, we need to know two things:
        // the title and id of the movie they want to add to 'favorites'.
        // we'll delimit those two pieces of data with this delimiter,
        // so that it's easy to parse-out.
        var FAVORITE_DATA_DELIMITER = "@@@",
            reFavoriteDataDelimiter = new RegExp(FAVORITE_DATA_DELIMITER);

        var homePage = new SPAViewKlass({
            html: document.getElementById("home-view").innerHTML,
            viewAnchor: document.getElementById("container"),
            ui:{
                'searchBox': '#search-textbox',
                'searchButton': '#search-button',
                'searchResultList': "#search-result-list"
            },
            events:[
                {event: 'keyup', element: 'searchBox', handler: 'onSearchBoxKeyup'},
                {event: 'click', element: 'searchButton', handler: 'onSearchClick'},
                {event: 'click', element: 'searchResultList', handler: 'mainEventHandler'}
            ],
            functions:{
                mainEventHandler:function(e){
                    if(e.target.id === BUTTON_TYPE_MOVIE)
                        this.onMovieButtonClick(e.target.value);
                    else if(e.target.id === BUTTON_TYPE_FAVORITE)
                        this.onAddToFavoritesButtonClick(e.target.value);
                },
                onMovieButtonClick:function(idOfMovie){
                    if(typeof idOfMovie !== 'string' || idOfMovie.length <= 0) throw "Cannot view movie page without an id";
                    
                    alert('show me the money for ' + idOfMovie);
                },
                onAddToFavoritesButtonClick:function(titleAndIdOfMovie){
                    if(typeof titleAndIdOfMovie !== 'string' || titleAndIdOfMovie.length <= 0) throw "Missing required title-and-id string for adding to favorites";

                    // when we insert the 'add to favorite' buttons to the view, the 'value' of those
                    // buttons are stuffed with the title and id of the movie they correspond to.
                    // let's parse that data out and make sure it's present - error out if not!
                    var titleAndIDTuple = titleAndIdOfMovie.split(reFavoriteDataDelimiter),
                        title = titleAndIDTuple[0],
                        id = titleAndIDTuple[1];

                    if(typeof title !== 'string' || title.length <= 0) throw "Encountered improperly formatted favorite-button value (missing title)";

                    if(typeof id !== 'string' || id.length <= 0) throw "Encountered improperly formatted favorite-button value (missing id)";

                    alert("title: " + title + " and id: " + id);
                },
                onRenderComplete:function(){
                    this.searchBox.focus();
                },
                performMovieSearch:function(strSearch){
                    app.clearFeedback();
                    if(typeof strSearch !== 'string'){
                        app.displayError("Search term must be a valid string");
                        return;
                    }

                    if(strSearch.length <= 0) return;

                    // TODO - busy icon
                    // TODO - button disabled, textbox disabled
                    var self = this;
                    ajax.request({
                        url: 'http://www.omdbapi.com/?s=' + strSearch,
                        type:'get',
                        success: function(strJsonResponse){

                            var omdbResponse = null;
                            try{
                                omdbResponse = JSON.parse(strJsonResponse);
                            }catch(e){
                                app.displayError("Encountered this error after movie request succeeded, please try again: " + e);
                                return;
                            }

                            if(omdbResponse == null){
                                app.displayError("Unexpected response format, please try again");
                                return;
                            }

                            if(omdbResponse.Response === 'False'){
                                var strError = typeof omdbResponse.Error === 'string' && omdbResponse.Error.length > 0 ? omdbResponse.Error : "Unknown error from OMDBAPI";
                                app.displayError(strError);
                                return;
                            }

                            if(!omdbResponse.Search){
                                app.displayError("Failed to retrieve any search results from OMDBAPI");
                                return;
                            }

                            self.displayMoveSearchResults(omdbResponse.Search);
                            // TODO - busy icon off
                            // TODO - button enabled, textbox enabled
                        },
                        error:function(status, xmlhttp){
                            var strError = typeof xmlhttp.responseText === 'string' ? xmlhttp.responseText : "Unknown error";
                            app.displayError("Encountered the following error, please try again: " + strError);
                            // TODO - busy icon off
                            // TODO - button enabled, textbox enabled
                        }
                    });
                },
                displayMoveSearchResults: function(results){
                    if(results == null){
                        app.displayError("Missing required result list, cannot show movie search results");
                        return;
                    }

                    // [{"Title":"Star Wars: Episode IV - A New Hope","Year":"1977","imdbID":"tt0076759","Type":"movie"}...]
                    var newResultListFragment = document.createDocumentFragment(),
                        newLi = null,
                        movieButton = null,
                        faveButton = null,
                        title = null,
                        imdbID = null;
                    for(var i = 0, iLen = results.length; i < iLen; i++){

                        title = results[i].Title;
                        imdbID = results[i].imdbID;
                        newLi = document.createElement("LI");

                        movieButton = document.createElement("BUTTON");
                        movieButton.type = 'button';
                        movieButton.id = BUTTON_TYPE_MOVIE;
                        movieButton.value = imdbID;
                        movieButton.appendChild( document.createTextNode(title) );
                        newLi.appendChild(movieButton);

                        faveButton = document.createElement("BUTTON");
                        faveButton.type = 'button';
                        faveButton.id = BUTTON_TYPE_FAVORITE;
                        faveButton.value = title + FAVORITE_DATA_DELIMITER + imdbID;
                        faveButton.appendChild( document.createTextNode('Add to Favorites') );//TODO - make this an icon
                        newLi.appendChild(faveButton);

                        newResultListFragment.appendChild(newLi);
                    }

                    this.searchResultList.innerHTML = "";
                    this.searchResultList.appendChild(newResultListFragment);
                },
                onSearchBoxKeyup: function(e){
                    if(e.keyCode === 13){
                        this.performMovieSearch(this.searchBox.value);  
                    } 
                },
                onSearchClick:function(e){
                    this.performMovieSearch(this.searchBox.value);
                }
            }
        });

        homePage.render();
        
    })(window,document,JSON,ajaxHelpers,spaApplication,SPAViewKlass);
    
    </script>
</html>